<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout('소설 상세', ~{::div.content-wrapper}, 'novel', null)}">
<body>

<div class="content-wrapper">
    <!-- 상단 네비게이션 및 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <a href="/admin/novel/list" class="btn btn-outline-secondary me-3">
                <i class="bi bi-arrow-left"></i> 목록
            </a>
            <h2 class="m-0 text-dark fw-bold">소설 상세 정보</h2>
        </div>
        <div>
            <!-- [수정] 수정 페이지로 이동하는 링크 추가 -->
            <a th:href="@{/admin/novel/update/{id}(id=${novel.id})}" class="btn btn-outline-primary me-2">
                <i class="bi bi-pencil"></i> 소설 수정
            </a>
            <!-- [수정] 삭제 기능을 위한 POST 폼 추가 -->
            <form th:action="@{/admin/novel/delete/{id}(id=${novel.id})}" method="post" class="d-inline" onsubmit="return confirm('이 소설과 관련된 모든 회차, 이미지가 영구적으로 삭제됩니다. 정말 삭제하시겠습니까?');">
                <button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash"></i> 삭제</button>
            </form>
        </div>
    </div>

    <!-- 1. 소설 기본 정보 카드 -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row">
                <!-- 표지 이미지 -->
                <div class="col-md-3 col-lg-2 mb-3 mb-md-0">
                    <img th:if="${novel.coverImageUrl}" th:src="${novel.coverImageUrl}" 
                         alt="Cover" class="img-fluid rounded shadow-sm w-100" style="object-fit: cover; aspect-ratio: 2/3;">
                    <div th:unless="${novel.coverImageUrl}" class="bg-secondary bg-opacity-10 rounded d-flex align-items-center justify-content-center w-100" style="aspect-ratio: 2/3;">
                        <div class="text-center text-muted">
                            <i class="bi bi-image fs-1"></i><br>No Cover
                        </div>
                    </div>
                </div>
                
                <!-- 상세 텍스트 -->
                <div class="col-md-9 col-lg-10">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-primary mb-2" th:text="${novel.category}">카테고리</span>
                            <span class="badge bg-success mb-2" th:if="${novel.status.name() == 'PUBLISHED'}">연재중</span>
                            <span class="badge bg-secondary mb-2" th:if="${novel.status.name() == 'DRAFT'}">임시저장</span>
                            <span class="badge bg-dark mb-2" th:if="${novel.status.name() == 'COMPLETED'}">완결</span>
                            
                            <h3 class="fw-bold mb-2" th:text="${novel.title}">소설 제목</h3>
                            <p class="text-muted mb-3">
                                <i class="bi bi-person-circle me-1"></i> <span th:text="${novel.author.nickname}">작가명</span>
                                <span class="mx-2">|</span>
                                <i class="bi bi-calendar3 me-1"></i> <span th:text="${#temporals.format(novel.createdAt, 'yyyy-MM-dd HH:mm')}">등록일</span>
                                <span class="mx-2">|</span>
                                <i class="bi bi-eye me-1"></i> 조회수 <span th:text="${novel.viewCount}">0</span>
                            </p>
                        </div>
                        <div class="text-end">
                            <h4 class="fw-bold text-primary mb-0">총 <span th:text="${#lists.size(episodes)}">0</span>화</h4>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="novel-description text-secondary">
                        <h6 class="fw-bold text-dark">줄거리</h6>
                        <!-- Summernote로 저장된 HTML 내용을 안전하게 출력 (th:utext) -->
                        <div th:utext="${novel.description}">작품 설명이 없습니다.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 에피소드(회차) 목록 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold m-0"><i class="bi bi-list-ol me-2"></i>회차 목록</h4>
        <!-- 에피소드 생성 페이지로 이동 -->
        <a th:href="@{/admin/episode/create(novelId=${novel.id})}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> 새 회차 등록
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4" style="width: 10%;">회차</th>
                            <th style="width: 50%;">제목</th>
                            <th style="width: 15%;">포인트</th>
                            <th style="width: 15%;">등록일</th>
                            <th style="width: 10%;">관리</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${#lists.isEmpty(episodes)}">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-file-earmark-x fs-1 d-block mb-3"></i>
                                등록된 회차가 없습니다. 첫 번째 이야기를 들려주세요!
                            </td>
                        </tr>
                        <tr th:each="episode : ${episodes}">
                            <td class="ps-4 fw-bold text-primary">
                                第 <span th:text="${episode.episodeNumber}">1</span> 화
                            </td>
                            <td>
                                <!-- [수정] 보기 기능: 제목 클릭 시 수정 페이지로 이동 -->
                                <a th:href="@{/admin/episode/update/{id}(id=${episode.id})}"
                                   class="text-decoration-none text-dark fw-bold">
                                    <span th:text="${episode.title}">회차 제목</span>
                                </a>
                                <!-- 이미지가 있으면 아이콘 표시 -->
                                <span class="badge bg-light text-secondary border ms-2" th:if="${!episode.images.isEmpty()}">
                                    <i class="bi bi-images"></i>
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-warning text-dark bg-opacity-25 border border-warning" th:text="${episode.requiredPoint} + ' P'">0 P</span>
                            </td>
                            <td th:text="${#temporals.format(episode.createdAt, 'yyyy-MM-dd')}">2024-01-01</td>
                            <td>
                                <!-- [수정] 수정 버튼 링크 추가 -->
                                <a th:href="@{/admin/episode/update/{id}(id=${episode.id})}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-pencil"></i></a>
                                <!-- [수정] 삭제 버튼 폼 추가 -->
                                <form th:action="@{/admin/episode/delete/{id}(id=${episode.id})}" method="post" class="d-inline" onsubmit="return confirm('이 회차를 정말 삭제하시겠습니까? 복구할 수 없습니다.');">
                                    <!-- 삭제 후 리다이렉션을 위해 novelId를 함께 전송 -->
                                    <input type="hidden" name="novelId" th:value="${novel.id}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</body>
</html>