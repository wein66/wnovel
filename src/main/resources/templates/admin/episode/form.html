<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout(${episode.id != null ? 'íšŒì°¨ ìˆ˜ì •' : 'íšŒì°¨ ë“±ë¡'}, ~{::div.content-wrapper}, 'novel', ~{::#css-resources})}">
<head>
    <th:block id="css-resources">
        <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
        <style>
            /* --- ë¸”ë¡ ì—ë””í„° ìŠ¤íƒ€ì¼ --- */
            /* ìº”ë²„ìŠ¤ (ul) ìŠ¤íƒ€ì¼ */
            #novel-canvas {
                list-style: none; /* ì  ì—†ì• ê¸° */
                padding: 10px;
                margin: 0;
                min-height: 400px;
                background: #f4f6f9;
                border: 1px dashed #aaa;
                border-radius: 5px;
            }
            /* ê³µí†µ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
            #novel-canvas li {
                position: relative;
                margin-bottom: 10px;
                border: 1px solid transparent; /* ì—ë””í„° ëª¨ë“œì—ì„œ ì˜ì—­ í‘œì‹œìš© */
            }
            /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ í¸ì§‘ ì˜ì—­ í‘œì‹œ */
            #novel-canvas li:hover {
                border: 1px dashed #007bff;
            }
            /* TYPE 3: í…ìŠ¤íŠ¸(ì§€ë¬¸/ë…ë°±) ìŠ¤íƒ€ì¼ */
            .text-type {
                padding: 20px;
                background: #fff;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
            }
            .narration-box {
                width: 90%;
                background: #fdfdfd;
                border: 1px solid #e0e0e0;
                padding: 20px;
                border-radius: 8px;
                color: #555;
                font-size: 1.05em;
                line-height: 1.6;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            /* TYPE 1: ë¯¸ì—°ì‹œ ë°°ê²½ ìŠ¤íƒ€ì¼ (SCENE) */
            .scene-type {
                height: 400px;
                background-color: #333; /* ì´ë¯¸ì§€ ì—†ì„ ë•Œ ê¸°ë³¸ìƒ‰ */
                background-size: cover;
                background-position: center;
                display: flex;
                align-items: flex-end; /* í…ìŠ¤íŠ¸ ë°•ìŠ¤ í•˜ë‹¨ ì •ë ¬ */
                position: relative;
                border-radius: 5px;
                overflow: hidden;
            }
            .scene-overlay {
                width: 100%;
                background: rgba(0, 0, 0, 0.7); /* ë°˜íˆ¬ëª… ê²€ì • ë°°ê²½ */
                color: white;
                padding: 20px;
                border-top: 2px solid orange;
            }
            /* TYPE 2: ì±„íŒ… ìŠ¤íƒ€ì¼ (CHAT) */
            .chat-type {
                display: flex;
                padding: 15px;
                background: #fff;
                border-bottom: 1px solid #eee;
            }
            .chat-thumb {
                width: 60px;
                height: 60px;
                background: #ddd;
                border-radius: 50%;
                overflow: hidden;
                margin-right: 15px;
                flex-shrink: 0;
            }
            .chat-thumb img { width: 100%; height: 100%; object-fit: cover; }
            .chat-content { flex-grow: 1; }
            .chat-bubble { background: #f1f0f0; padding: 10px 15px; border-radius: 15px; display: inline-block; margin-top: 5px; }
            /* ì—ë””í„° ì „ìš© UI (ì €ì¥í•  ë• ì œê±°ë¨) */
            .name-field { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; display: block; color: #ffcc00; /* ì´ë¦„ ê°•ì¡° */ }
            [contenteditable]:empty:before { content: attr(placeholder); color: #ccc; display: block; /* For Firefox */ }
            .editor-controls { position: absolute; top: 5px; right: 5px; z-index: 100; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 4px; display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */ }
            #novel-canvas li:hover .editor-controls { display: block; /* ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ ë³´ì„ */ }
            .btn-upload { cursor: pointer; color: blue; margin-right: 5px; }
            .btn-delete { cursor: pointer; color: red; }
            .note-editable { background-color: white; }
        </style>
    </th:block>
</head>
<body>

<div class="content-wrapper">
    <div class="d-flex align-items-center mb-4">
        <a th:href="@{/admin/novel/detail/{id}(id=${novelId})}" class="btn btn-outline-secondary me-3">
            <i class="bi bi-arrow-left"></i> ì†Œì„¤ ìƒì„¸ë¡œ
        </a>
        <h2 class="m-0 text-dark fw-bold" th:text="${episode.id != null ? 'íšŒì°¨ ìˆ˜ì •' : 'ìƒˆ íšŒì°¨ ë“±ë¡'}">ìƒˆ íšŒì°¨ ë“±ë¡</h2>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <form id="episodeForm" th:action="${episode.id != null} ? @{/admin/episode/update/{id}(id=${episode.id})} : @{/admin/episode/create}"
                          th:object="${episode}" method="post">
                        <input type="hidden" name="novelId" th:value="${novelId}">
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label for="title" class="form-label fw-bold">íšŒì°¨ ì œëª© <span class="text-danger">*</span></label>
                                <!-- [ìˆ˜ì •] th:field ì ìš© ë° placeholder ìˆ˜ì • -->
                                <input type="text" class="form-control" id="title" th:field="*{title}" placeholder="ì œëª©ì„ ë¹„ì›Œë‘ë©´ ì´ì „ íšŒì°¨ ì œëª©(ë˜ëŠ” ì†Œì„¤ ì œëª©)ì´ ìë™ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.">
                            </div>
                            <div class="col-md-2">
                                <label for="episodeNumber" class="form-label fw-bold">íšŒì°¨ ë²ˆí˜¸</label>
                                <!-- [ìˆ˜ì •] th:field ì ìš©, ìˆ˜ì • ì‹œ ì½ê¸° ì „ìš©ìœ¼ë¡œ ë³€ê²½ -->
                                <input type="number" class="form-control" id="episodeNumber" th:field="*{episodeNumber}" th:readonly="${episode.id != null}" required>
                            </div>
                            <div class="col-md-2">
                                <label for="requiredPoint" class="form-label fw-bold">ì°¨ê° í¬ì¸íŠ¸</label>
                                <input type="number" class="form-control" id="requiredPoint" th:field="*{requiredPoint}" min="0">
                            </div>
                        </div>

                        <!-- Summernote ì—ë””í„° -->
                        <div class="mb-4">
                            <label class="form-label fw-bold mb-3">ë³¸ë¬¸ ë‚´ìš©</label>

                            <!-- [ìˆ˜ì •] ì—ë””í„° ì„ íƒ íƒ­ -->
                            <ul class="nav nav-tabs" id="editorTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="summernote-tab" data-bs-toggle="tab" data-bs-target="#summernote-pane" type="button" role="tab">ì¼ë°˜ ì—ë””í„°</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="block-editor-tab" data-bs-toggle="tab" data-bs-target="#block-editor-pane" type="button" role="tab">ë¸”ë¡ ì—ë””í„°</button>
                                </li>
                            </ul>

                            <!-- [ìˆ˜ì •] íƒ­ ì»¨í…ì¸  -->
                            <div class="tab-content border border-top-0 p-3" id="editorTabContent">
                                <!-- 1. Summernote ì—ë””í„° -->
                                <div class="tab-pane fade show active" id="summernote-pane" role="tabpanel">
                                    <textarea id="summernote" name="content" th:text="*{content}"></textarea>
                                    <div class="text-end mt-2 text-muted">
                                        <small>í˜„ì¬ ê¸€ì ìˆ˜: <span id="charCount" class="fw-bold text-primary">0</span>ì (ê³µë°± í¬í•¨)</small>
                                    </div>
                                </div>
                                <!-- 2. ë¸”ë¡ ì—ë””í„° -->
                                <div class="tab-pane fade" id="block-editor-pane" role="tabpanel">
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSceneBlock()">ğŸ–¼ï¸ ë°°ê²½(ê²Œì„í˜•) ì¶”ê°€</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addChatBlock()">ğŸ’¬ ì¸ë„¤ì¼(ì±„íŒ…) ì¶”ê°€</button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTextBlock()">ğŸ“ í…ìŠ¤íŠ¸(ì§€ë¬¸) ì¶”ê°€</button>
                                    </div>
                                    <ul id="novel-canvas"></ul>
                                </div>
                            </div>

                        </div>

                        <div class="d-flex justify-content-end border-top pt-4">
                            <!-- [ìˆ˜ì •] ë²„íŠ¼ í…ìŠ¤íŠ¸ ë™ì  ë³€ê²½ -->
                            <button type="submit" class="btn btn-primary px-5" th:text="${episode.id != null ? 'ìˆ˜ì • ì™„ë£Œ' : 'íšŒì°¨ ë“±ë¡ ì™„ë£Œ'}">íšŒì°¨ ë“±ë¡ ì™„ë£Œ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
            // --- í¼ ì œì¶œ ë¡œì§ ìˆ˜ì • ---
            $('#episodeForm').on('submit', function() {
                // ë¸”ë¡ ì—ë””í„° íƒ­ì´ í™œì„±í™” ìƒíƒœì´ë©´, í•´ë‹¹ ì»¨í…ì¸ ë¥¼ summernote textareaì— ì±„ì›Œë„£ìŒ
                if ($('#block-editor-tab').hasClass('active')) {
                    prepareBlockContent();
                }
            });

            // [ìˆ˜ì •] Summernoteì— ê¸°ì¡´ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì±„ì›Œë„£ê³  ì‹œì‘
            const initialContent = $('#summernote').val();

            $('#summernote').summernote({
                placeholder: 'ì†Œì„¤ ë³¸ë¬¸ì„ ì‘ì„±í•˜ì„¸ìš”. ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë³¸ë¬¸ì— ì‚½ì…ë©ë‹ˆë‹¤.',
                tabsize: 2,
                height: 600,
                lang: 'ko-KR',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['insert', ['picture', 'link']],
                    ['view', ['fullscreen', 'codeview']]
                ],
                callbacks: {
                    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì½œë°±
                    onImageUpload: function(files) {
                        for (let i = 0; i < files.length; i++) {
                            uploadImage(files[i]);
                        }
                    },
                    // [ì¶”ê°€] í…ìŠ¤íŠ¸ ë³€ê²½ ê°ì§€ ì½œë°± (í‚¤ ì…ë ¥, ë¶™ì—¬ë„£ê¸° ë“±)
                    onChange: function(contents, $editable) {
                        // HTML íƒœê·¸ë¥¼ ì œì™¸í•œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ê¸¸ì´ ê³„ì‚°
                        // $(this).summernote('text')ëŠ” íƒœê·¸ê°€ ì œê±°ëœ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
                        const textLength = $(this).summernote('text').length;
                        $('#charCount').text(textLength.toLocaleString());
                    },
                    // [ì¶”ê°€] ì´ˆê¸°í™” ì‹œ ê¸€ì ìˆ˜ ê³„ì‚°
                    onInit: function() {
                        // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ, ì´ˆê¸° í…ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ summernote('code')ë¡œ ë‹¤ì‹œ ì„¤ì •
                        if (initialContent) {
                            $(this).summernote('code', initialContent);
                        }
                        // [ìˆ˜ì •] ë‚´ìš©ì´ ì„¤ì •ëœ í›„ ê¸€ì ìˆ˜ ê³„ì‚°
                        const currentText = $(this).summernote('text') || ''; // undefined ë°©ì§€
                        const textLength = currentText.length;
                        $('#charCount').text(textLength.toLocaleString());
                    }
                }
            });

            // --- ë¸”ë¡ ì—ë””í„° ì´ˆê¸°í™” ---
            // ìˆ˜ì • ëª¨ë“œì¼ ë•Œ, content ë‚´ìš©ì´ ë¸”ë¡ ì—ë””í„° í˜•ì‹ì¸ì§€ í™•ì¸í•˜ê³  ìº”ë²„ìŠ¤ì— ë Œë”ë§
            // (ê°„ë‹¨í•˜ê²Œ li íƒœê·¸ê°€ ìˆëŠ”ì§€ ì—¬ë¶€ë¡œ íŒë‹¨)
            if (initialContent && initialContent.trim().startsWith('<li')) {
                $('#novel-canvas').html(initialContent);
                // ë¸”ë¡ ì—ë””í„° íƒ­ì„ í™œì„±í™”
                new bootstrap.Tab($('#block-editor-tab')).show();
            }

            function uploadImage(file) {
                let formData = new FormData();
                formData.append('file', file);
                formData.append('novelId', '[[${novelId}]]');

                $.ajax({
                    url: '/admin/api/episode/upload-image',
                    method: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(url) {
                        $('#summernote').summernote('insertImage', url);
                    },
                    error: function(err) {
                        console.error(err);
                        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            }

            // 7. [ì¤‘ìš”] í¼ ì „ì†¡ ì „ ì •ë¦¬ ì‘ì—… (HTML Clean-up)
            function prepareBlockContent() {
                let $clone = $('#novel-canvas').clone();
                $clone.find('.editor-controls').remove();
                $clone.find('[contenteditable]').removeAttr('contenteditable placeholder');
                
                // ì •ë¦¬ëœ HTMLì„ summernote textareaì— ë‹´ê¸°
                // ì„œë²„ëŠ” content íŒŒë¼ë¯¸í„° í•˜ë‚˜ë§Œ ë°›ìœ¼ë©´ ë¨
                $('#summernote').val($clone.html());
            }
        });

        /**
         * [ìˆ˜ì •] ë¸”ë¡ ì—ë””í„°ìš© ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¨ìˆ˜
         * Summernoteì˜ uploadImage í•¨ìˆ˜ì™€ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.
         * @param {File} file - ì—…ë¡œë“œí•  ì´ë¯¸ì§€ íŒŒì¼
         * @param {function} successCallback - ì—…ë¡œë“œ ì„±ê³µ ì‹œ í˜¸ì¶œë  ì½œë°± í•¨ìˆ˜ (íŒŒë¼ë¯¸í„°: ì´ë¯¸ì§€ URL)
         */
        function uploadBlockImage(file, successCallback) {
            let formData = new FormData();
            formData.append('file', file);
            formData.append('novelId', '[[${novelId}]]');

            $.ajax({
                url: '/admin/api/episode/upload-image', // Summernoteì™€ ë™ì¼í•œ API ì‚¬ìš©
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: successCallback, // ì„±ê³µ ì‹œ ì „ë‹¬ë°›ì€ ì½œë°± í•¨ìˆ˜ ì‹¤í–‰
                error: function(err) {
                    console.error(err);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ==================================================
        //               ë¸”ë¡ ì—ë””í„° ìŠ¤í¬ë¦½íŠ¸ (ì „ì—­ ìŠ¤ì½”í”„ë¡œ ì´ë™)
        // ==================================================

        // 1. ë°°ê²½í˜•(ë¯¸ì—°ì‹œ) ë¸”ë¡ ì¶”ê°€
        function addSceneBlock() {
            let html = `
                <li class="scene-type">
                    <div class="editor-controls">
                        <label class="btn-upload">
                            ğŸ“· ë°°ê²½ ë³€ê²½
                            <input type="file" accept="image/*" style="display:none" onchange="previewBg(this)">
                        </label>
                        <span class="btn-delete" onclick="removeBlock(this)">âŒ ì‚­ì œ</span>
                    </div>
                    <div class="scene-overlay">
                        <div class="name-field" contenteditable="true" placeholder="ì´ë¦„"></div>
                        <div class="text-field" contenteditable="true" placeholder="ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></div>
                    </div>
                </li>
            `;
            $('#novel-canvas').append(html);
        }

        // 2. ì¸ë„¤ì¼í˜•(ì±„íŒ…) ë¸”ë¡ ì¶”ê°€
        function addChatBlock() {
            let html = `
                <li class="chat-type">
                    <div class="editor-controls">
                        <label class="btn-upload">
                            ğŸ“· ì‚¬ì§„ ë³€ê²½
                            <input type="file" accept="image/*" style="display:none" onchange="previewThumb(this)">
                        </label>
                        <span class="btn-delete" onclick="removeBlock(this)">âŒ ì‚­ì œ</span>
                    </div>
                    <div class="chat-thumb">
                        <img src="https://via.placeholder.com/60" alt="í”„ë¡œí•„">
                    </div>
                    <div class="chat-content">
                        <div class="name-field" style="color:#333;" contenteditable="true" placeholder="ì´ë¦„"></div>
                        <div class="chat-bubble" contenteditable="true" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                    </div>
                </li>
            `;
            $('#novel-canvas').append(html);
        }

        // 3. í…ìŠ¤íŠ¸(ì§€ë¬¸) ë¸”ë¡ ì¶”ê°€
        function addTextBlock() {
            let html = `
                <li class="text-type">
                    <div class="editor-controls">
                        <span class="btn-delete" onclick="removeBlock(this)">âŒ ì‚­ì œ</span>
                    </div>
                    <div class="narration-box" contenteditable="true" placeholder="ìƒí™© ì„¤ëª…ì´ë‚˜ ë…ë°±ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
                </li>
            `;
            $('#novel-canvas').append(html);
        }

        // 4. ë¸”ë¡ ì‚­ì œ ê¸°ëŠ¥
        function removeBlock(btn) {
            if(confirm('ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                $(btn).closest('li').remove();
            }
        }

        // 5. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ë°°ê²½í˜•)
        function previewBg(input) {
            const file = input.files[0];
            if (file) {
                // [ìˆ˜ì •] ì„œë²„ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ URLì„ ë°°ê²½ìœ¼ë¡œ ì„¤ì •
                uploadBlockImage(file, function(url) {
                    $(input).closest('li.scene-type').css('background-image', `url(${url})`);
                });
            }
        }

        // 6. ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ì±„íŒ…í˜•)
        function previewThumb(input) {
            const file = input.files[0];
            if (file) {
                // [ìˆ˜ì •] ì„œë²„ì— ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ URLì„ srcë¡œ ì„¤ì •
                uploadBlockImage(file, function(url) {
                    $(input).closest('li.chat-type').find('.chat-thumb img').attr('src', url);
                });
            }
        }
    </script>
</div>

</body>
</html>